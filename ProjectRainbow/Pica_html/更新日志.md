# 🚛 无人红色皮卡的安保之旅 - 更新日志

---

## 2026-02-24 (第六次会话)

### 🔧 调整 - 后备箱升级取消金币消耗
- `TRUNK_UPGRADES` 配置中移除所有等级的 `gold` 字段（原 10/25/50/80 金币）
- `canUpgradeTrunk()` 移除金币余额检查
- `upgradeTrunk()` 移除金币余额检查与 `spendGold()` 调用
- 升级弹窗 UI（`showTrunkUpgradeModal()`）移除金币费用行
- 升级按钮悬停 tooltip 移除金币费用行
- **现在升级仅消耗材料（废金属/铜线/橡胶/电池），不再花费金币**

### 🔧 调整 - 钱包漏洞 debuff 加入触发概率
- `game-config.js`：`wallet_leak` 新增 `perChoiceChance: 0.25` 字段，描述更新为「每次事件抉择后，25% 概率金币 -1（每层叠加概率）」
- `event-handler.js`：`applyActiveDebuffs()` 中 `perChoice` 块新增通用概率判断——若 debuff 配置了 `perChoiceChance`，则按 `perChoiceChance × 层数`（cap 到 100%）掷骰，未触发时跳过本次扣减
- **钱包漏洞 1 层 = 25% 概率触发，4 层才保证每次都触发**

### 🐛 修复 - 终点结局按钮逃逸出弹窗
- **问题**：`journey_end` 结局时，「查看旅途历程」和「鸣谢名单」按钮渲染在白色卡片之外
- **原因**：`journey_end` 结局块末尾多写了一个 `</div></div>`，多余的关闭标签意外提前关闭了 `.ending-modal-inner` 卡片容器
- **修复**：将末尾 `</div></div>` 改为单个 `</div>`，卡片容器由最末尾统一关闭

### ✨ 功能 - 终点事件两阶段背景特效

#### 阶段一：事件弹窗阶段（`journey_end_question` 触发时）
- **紫色染色幕**：全屏 `radial-gradient` 叠层从底部渐入（`z-index:48`），1.2s 缓慢浸染氛围
- **三叉路光束**：三条从画面底部中央散开的紫色发光光柱（偏左 22°、正中、偏右 22°），带 `blur` 滤镜和呼吸脉动动画（`jendBeam`），暗示命运三叉路
- 玩家做出选择后（`journey_end` effect 处理完成时）特效自动 1.3s 淡出消散（`stopJourneyEndEventEffect()`）
- 新增 `startJourneyEndEventEffect()` / `stopJourneyEndEventEffect()` 函数于 `game-over.js`
- `event-handler.js` 触发 `journey_end_question` 时自动调用启动函数

#### 阶段二：结局弹窗阶段（`showGameOver("journey_end")` 后）
- **全屏 Canvas 粒子层**（`z-index:0`，在结局卡片下方）：
  - **公路消逝光束**（55 粒）：透视视角从中央向两侧飞散，带生命周期渐变与随机长度/颜色（紫白配色）
  - **漂浮星尘**（40 粒）：随机漂浮上升，带正弦呼吸脉冲
  - **地平线光晕**：底部放射状紫色渐变，强化「公路尽头」感
- 结局卡片加 `position:relative; z-index:1`，始终浮于粒子特效之上
- 新增 CSS keyframe `jendBeam`（光束呼吸动画）

### 🔊 功能 - 升级与制作音效
- **`playUpgrade()`**：后备箱升级成功时播放 C5→E5→G5→C6 四音上行大和弦，末音叠 E6 泛音，有「等级提升」爽感
- **`playCraft()`**：合成成功时播放两声低沉锤击（锯齿波低通滤波）+ 一声明亮叮响，工匠感
- `inventory-display.js`：`doTrunkUpgrade()` 成功时调用 `playUpgrade()`，`doCraft()` 成功时调用 `playCraft()`

### 🔊 功能 - 命运轮盘背景音乐
- **`startFateRouletteMusic()` / `stopFateRouletteMusic()`**：三层神秘循环背景音
  - 层 1：A1 低频嗡鸣（锯齿波 + 低通滤波 + 0.35Hz LFO 颤音）
  - 层 2：A2/A2.07Hz 微失调双音制造「哇哇」拍频，0.8Hz LFO 调制
  - 层 3：随机神秘短音序列，从 A2~B3 五声音阶随机选音，间隔 0.6~2.4s，含随机微失调
  - 0.8s 渐入，0.8s 渐出
- **`playRouletteSpinStart()`**：转盘启动时播放「嗖」加速扫频（80→600Hz 锯齿波）
- **`playRouletteSpinStop()`**：转盘停止时播放低频碰撞冲击 + 金属回响
- `event-handler.js`：`showFateRouletteModal()` 开头调用 `startFateRouletteMusic()`，`spinFateRoulette()` 调用旋转音效，`_closeFateRouletteModal()` 调用 `stopFateRouletteMusic()`

### 🔊 功能 - 时间银行背景音乐
- **`startTimeBankMusic()` / `stopTimeBankMusic()`**：三层命运感时钟循环背景音
  - 层 1：规律「滴-哒」双击节拍（800ms/拍，高音 1600Hz / 低音 1200Hz 交替）
  - 层 2：每两拍一次轻回声（1400Hz，0.25s 延迟）
  - 层 3：D2/D3 八度持续钟声共鸣，0.2Hz LFO 缓慢渐强渐弱
  - 0.8s 渐入，0.6s 渐出
- `event-handler.js`：`showTimeBankDepositModal()` / `showTimeBankWithdrawModal()` 末尾调用 `startTimeBankMusic()`，`closeTimeBankModal()` 开头调用 `stopTimeBankMusic()`

### 🔊 功能 - Debug 操作音效
- **`playDebugAction()`**：Debug 面板触发事件或添加物品时播放电子乱码扫频（锯齿波 1800→400→1200→200Hz 扫描 + 低频赛博朋克脉冲）
- `audio.js` 中 `debugTriggerEvent()` 和 `debugAddItem()` 的 `debugUsed = true` 之后调用

### 🔊 功能 - 金币获得音效
- **`playGoldCoin()`**：获得金币时播放 C6+E6 双音金属碰撞叮响（0.22s）
- `inventory-system.js`：`addGold(amount)` 中 `amount > 0` 时调用

### 🔊 功能 - 属性恢复音效
- **`playStatRestore(type)`**：三种差异化音效
  - `fuel`：低沉上扫正弦波（80→220Hz），「加油」质感
  - `durability`：短促金属双击（160Hz + 200Hz，锯齿波低通），「修缮」质感
  - `comfort`：C5→E5→G5 三连拨奏（三角波），「舒适」质感
  - 内置 120ms 节流，防止同帧多属性同时触发叠音
- `inventory-display.js`：`updateTruckStatusDisplay()` 中检测三属性变化，分类调用

### 🔊 功能 - 事件选项确认音效
- **`playEventChoice()`**：事件选项按钮点击时播放中频下扫 + 低频脉冲（0.12s），有「决策确认」感
- `event-handler.js`：`handleEventChoice()` 最开头调用

### ✨ 功能 - 好结局鸣谢弹窗
- 所有好结局（`perfect_journey` / `eternal_friendship` / `collector` / `legendary_driver` / `lonely_wanderer` / `harmony` / `overloaded` / `journey_end`）底部显示「🎖️ 鸣谢名单」按钮
- **`openCreditsModal()` / `closeCreditsModal()`**：弹出全屏鸣谢界面，带入场动画（`creditsModalIn`）
  - 接龙大赛鸣谢名单（路过的红色皮卡、猫猫D菌、尘聲、龙QAVC）
  - 感谢 Claude Sonnet 4.6

### ✨ 功能 - 终点结局 ASCII 艺术 CG
- `journey_end` 结局弹窗内嵌 14 行公路/皮卡 ASCII 图案（`pre.journey-end-ascii`）
- 带边框装饰与「T H E   R O A D   E N D S」题字

### ✨ 优化 - 结局弹窗视觉增强
- 入场动画：`endingModalIn`（0.45s cubic-bezier 缩放+上浮）
- 外发光：`box-shadow` 随各结局主题色变化（`glowColor` 双层扩散光晕）
- `.ending-modal-inner` 加 `position:relative; z-index:1`，与粒子特效层正确隔离

### ✨ 优化 - 整体 UI 视觉细节
- 属性状态栏：悬停时 `border-color` 亮化 + 微发光（`box-shadow 0 0 10px rgba(255,255,255,0.04)`）
- 燃油/耐久/舒适进度条：各自带对应颜色发光（黄/绿/蓝 `box-shadow`）
- 里程记录表行：悬停背景微亮（`.mileage-row:hover`）
- 所有 `button` 统一 `transition: all 0.2s ease`
- 游戏画布边框外发光增强

---

## 2026-02-24 (第五次会话)

### ✨ 功能 - 古老的神庙事件 + 扫雷小游戏
- 新增特殊事件 **古老的神庙** `ancient_temple`，强制在第 **10** 个事件触发（`oneTime: true`，`triggerWeight: 0`）
- **选项一「解开谜题」**：打开 20×20 扫雷谜题（36 个雷），限时 60 秒
  - 左键翻开格子，右键插旗标记地雷
  - 踩雷不结束游戏，仅揭示该格
  - 倒计时结束自动结算：正确标记 +1🪙，错误标记 -1🪙，总收益保底为 0
- **选项二「祈祷」**：权重随机恢复小幅属性（舒适/燃油/耐久）
- **选项三「离开」**：安全离开，无消耗
- 新建 `js/gameplay/minesweeper.js`（扫雷核心逻辑 + 模态框 UI + 计时器 + 结算系统）
- `event-handler.js` 中 `checkEventTrigger()` 新增第 10 事件强制插入逻辑
- `applyBasicEffect()` 新增 `openMinesweeper` 效果类型
- 两处 `hasOpenSubModal` 检查均新增 `minesweeper-modal` 防止提前恢复游戏

### ✨ 功能 - 全局衰变 debuff 系统
- 每经历 **10** 个事件选择后，自动获得一个随机全局 debuff，层数可叠加
- **9 种 debuff**：
  - ⛽ 油箱老化：每次抉择后燃油 -1%/层
  - 🔩 车架腐蚀：每次抉择后耐久 -1%/层
  - 😩 旅途疲惫：每次抉择后舒适 -1%/层
  - 💸 钱包漏洞：每次抉择后金币 -1/层
  - 📦 沉重负担：获得时最大载重 -3kg/层
  - 🎲 霉运加深：每次抉择后 15%×层数 概率随机属性 -3%
  - ⏳ 全面老化：每次抉择后燃油/耐久/舒适各 -0.5%/层
  - 🛢️ 油耗飙升：每次抉择后燃油 -2%/层
  - 🔧 嘎吱车身：每次抉择后耐久 -0.5%、舒适 -0.5%/层
- **debuff 显示栏**：游戏画面上方橙色标签栏，显示所有激活的 debuff 和层数，悬停查看详细说明
- **存档兼容**：`activeDebuffs` 和 `easyMode` 已加入 save/load 向后兼容

### 🛡️ 功能 - 简单模式
- 在困难模式选择界面新增 **简单模式** 开关，勾选后关闭衰变 debuff 系统
- 开启简单模式时，困难模式标签栏显示 🛡️ 简单模式 标签
- 开始按钮动态显示「🛡️ 简单旅程」/「🛡️ 简单挑战」等对应文案
- 设置通过 sessionStorage + localStorage 在页面间传递和记忆

### 🔧 调整 - 背景景观层
- 远景/中景/近景高度整体上移 +10%（底部位置 48%/32%/24%）
- 远景亮度降至 40%、颜色暗化约 40%
- 中景亮度降至 55%、颜色暗化约 30%
- 三层间距拉开避免重叠，提升视觉层次感

### ✨ 功能 - 新增 3 种困难模式特殊加成
- 🌿 **后备箱培养仓**（8分）：每次事件抉择后 15% 概率获得草药×1，实现于 `applyHardModePerChoice()`
- 💳 **会员卡**（6分）：商店购买物品价格 -20%，实现于 `getEffectiveBuyPrice()` 价格折扣链
- 📦 **更好的开局**（12分）：开局后备箱额外获得 2~3 种随机基础物资（废金属、布料、草药、空罐、原油），每种 1~2 个，实现于 `initializeGame()` onStart 逻辑

---

## 2026-02-23 (第四次会话)

### ✨ 功能 - ASCII 背景景观系统
- 新建 `js/game_show/scenery.js`（531 行），在游戏画面中用暗色汉字/ASCII 符号构建行驶沿途的远景
- **8 种场景**：远山 `mountain`、密林 `forest`、城镇 `city`、废墟 `ruins`、荒漠 `desert`、雪原 `snowfield`、海岸 `coast`、荒野 `plains`（默认开始场景）
- **3 层视差滚动**：
  - 远景 (far)：速度 3.6px/帧，透明度 70%，字号 13px
  - 中景 (mid)：速度 7.2px/帧，透明度 80%，字号 14px
  - 近景 (near)：速度 12.0px/帧，透明度 90%，字号 15px
- **自动场景切换**：每 2~3 次事件选择后淡出→换场→淡入（1.5 秒过渡），随机选择不同场景
- **无缝循环**：每层用两份相同内容拼接，偏移超出一个 block 宽度时自动重置
- **场景过渡修复**：淡出期间保持 offset 不重置，淡入前双帧等待确保布局完成 + blockWidth 缓存 + offset 取模校正，杜绝背景突然出现的衔接问题
- **与游戏同步**：事件触发时暂停、事件结束时恢复（集成在 `pauseRoad` / `resumeRoad` 中）
- **性能优化**：使用 `translateX` 做 GPU 合成动画；缓存 block 宽度避免每帧强制回流
- **HTML 集成**：`#scenery` 容器加渐变遮罩（`mask-image`），顶部/底部平滑过渡；公路 `z-[5]`、皮卡 `z-10` 确保层级正确

### 🔧 调整 - 变形珍品重量归零
- 黯淡的猎人徽章、破损的雕塑、空白书：重量从 2/5/2 → **0**
- 变形后的珍品仅保留纪念价值，不再占用后备箱载重

### ✨ 优化 - 事件弹窗淡入淡出动画
- 新增 CSS 关键帧 `eventModalFadeIn`（0.25s 淡入）、`eventModalFadeOut`（0.2s 淡出）、`eventInnerSlideIn`（0.3s 内容滑入）
- `#event-modal` 和 `#sub-choice-modal` 打开时渐显 + 内容上浮动画
- 关闭时添加 `.modal-fade-out` 类触发渐隐后移除 DOM
- 新增 `fadeOutAndRemoveModal(modalId, callback)` 通用淡出工具函数

### 🐛 修复 - 物品使用/丢弃后 tooltip 残留
- **问题**：使用或丢弃物品后，tooltip 仍悬浮在原位不消失
- **原因**：DOM 重建移除了被 hover 的元素，`onmouseleave` 永远不会触发
- **修复**：在 `useItemFromInventory()` 和 `discardItemFromInventory()` 中显式调用 `hideInventoryTooltip()`

### ✨ 功能 - 后备箱升级系统
- `game-state.js`：新增 `inventoryState.trunkLevel = 1`
- `inventory-system.js`：新增 `TRUNK_UPGRADES` 配置（5 级）、`canUpgradeTrunk()`、`upgradeTrunk()` 函数
  - Lv.2：10金 + 废金属×2，+5kg
  - Lv.3：25金 + 废金属×4 + 铜线×2，+5kg
  - Lv.4：50金 + 废金属×6 + 橡胶×3，+5kg
  - Lv.5：80金 + 废金属×8 + 电池×2 + 铜线×4，+10kg
- `inventory-display.js`：新增升级弹窗 UI（等级圆点进度条、费用列表、淡入淡出动画）
- `game.html`：后备箱标题旁新增 Lv 徽章（金色，满级变绿色）+ 蓝色「⬆ 升级」按钮
- `save-system.js`：旧存档兼容，`trunkLevel` 默认为 1

### ✨ 优化 - 富文本 Tooltip 系统
- `getItemTooltipHtml(config)`：返回完整 HTML，包含彩色物品名、分类徽章、描述、使用效果（燃油黄/耐久绿/舒适蓝）、被动效果（紫色）、变形信息
- `showInventoryTooltip(el)`：支持 `data-tooltip-html`（innerHTML 渲染）和 `data-tooltip`（纯文本）双模式
- Tooltip 元素样式升级：渐变背景、280px 最大宽度、10px 圆角、增强阴影
- 升级按钮悬停 tooltip：显示下一级费用/效果，材料以 ✔（绿色）/ ✘（红色）标识持有状态

### ✨ 优化 - 超载弹窗快捷操作
- 超载弹窗新增「⬆ 升级后备箱」和「🔨 制作」两个快捷按钮
- 从超载弹窗打开升级/制作后关闭时自动刷新超载弹窗状态
- 后备箱满级时隐藏升级按钮

### 🐛 修复 - 二级弹窗后游戏进程阻塞
- **问题**：在二级选择弹窗（sub-choice-modal）中做出选择后，游戏卡死不再推进
- **原因**：`handleSubChoice()` 使用淡出动画（0.2s `animationend`）异步移除 DOM，但紧接着同步检查 `sub-choice-modal` 是否还在 DOM 中（`hasOpenSubModal`）。动画未完成时元素仍存在 → `resumeGame()` 永远不被调用
- **修复**：二级弹窗改为 `modal.remove()` 立即移除，不使用淡出动画

### 🔧 优化 - 升级材料掉落率调整
- **背景**：铜线/橡胶/电池此前仅能从科技商人处购买（价格 8g/12g/22g），导致后备箱升级 Lv3-Lv5 材料获取难度过高
- **随机掉落表优化**（`inventory-events.js`）：
  - 「默认」表新增：铜线(权重6)、橡胶(权重5)、电池(权重3)
  - 「稀有」表新增：铜线(权重8)、橡胶(权重6)、电池(权重5)
  - 「废料」表新增：铜线(权重8)、橡胶(权重6)、电池(权重4)
  - 所有包含 `randomLoot` 的事件选项均自动获得铜线/橡胶/电池的随机掉落机会
- **直接概率掉落**（events-stop.js / events-special.js）：
  - 废弃仓库 - 深入搜刮：25% 铜线
  - 废弃仓库 - 快速搜索：15% 橡胶
  - 废弃矿场 - 深入矿场：25% 橡胶
  - 废弃矿场 - 地表搜刮：20% 铜线
  - 废弃加油站 - 彻底搜索：25% 电池
  - 废弃加油站 - 快速搜索：15% 橡胶
  - 废弃加油桩 - 撬开储藏室：20% 电池
  - 废弃农场 - 搜刮农场：15% 橡胶
  - 废弃广播塔 - 搜寻电子废料：30% 铜线+电池
  - 废弃村庄 - 进村搜索：20% 铜线
  - 陨石坑 - 下去探索：20% 橡胶
  - 神秘箱子 - 打开：各 5% 铜线/橡胶/电池
- 每个直接掉落均附带独立的叙事文本，融入事件情境
- 更新了所有受影响选项的 `hintKnown` 提示文本

---

## 2026-02-23 (第三次会话 续)

### ✨ 优化 - 超载弹窗滚动位置保留
- 超载界面中丢弃/使用物品后，物品列表不再重置到顶部，保持原有滚动位置

### 🔧 调整 - 萤火虫之愿削弱
- 被动效果从 100% 触发改为 **25% 概率触发**（每次进入夜晚事件时掷骰）
- 物品描述同步更新

### 🔧 调整 - 路边休息站事件选项重做
- **停车休整**：原为打开物品栏 / 燃油 -6 → **耐久 +10 / 金币 -5**（需至少 5 金币，金币不足时选项灰显）
- **小憩片刻**：舒适 +6 / 燃油 -8 → **舒适 +10 / 金币 -5**（需至少 5 金币，金币不足时选项灰显）
- **继续赶路**：原为每位乘客舒适 -2 / 燃油 -2 / 全员好感 -3 → **燃油 -6**（移除好感/舒适惩罚）
- **设计意图**：休息站改为金币消费型事件，提供耐久/舒适的可靠恢复手段；继续赶路作为免费但有燃油代价的保底选项

### 🔧 调整 - 夜幕降临事件选项数值重做
- **生火扎营**：舒适 +15 / 燃油 -10 → **耐久 +8**（移除燃油消耗，效果改为修复耐久）
- **轮流守夜**：舒适 +8 / 燃油 -10 → **舒适 -12 / 耐久 +15**（移除燃油消耗，增加安全感但牺牲舒适）
- **仰望星空**：舒适 +9 / 燃油 -8 → **舒适 +3**（移除燃油消耗）；新增 12% 概率获得珍品「天马星座的流星」
- **深夜奇遇**：保留为唯一有燃油消耗（-10）的选项，所有随机结果均附带 燃油 -10；提示文本更新
- **设计意图**：夜间事件不再全面消耗燃油，深夜奇遇作为高风险高收益选项承担唯一的燃油代价

### ✨ 功能 - 新珍品「天马星座的流星」
- **获取方式**：夜幕降临事件选择「仰望星空」后，12% 概率获得
- **被动效果**：持有时，每次进入夜晚相关事件自动获得 1 金币
- **物品属性**：颜色 `#c084fc`（淡紫色）、重量 4、不可堆叠
- **触发提示**：进入夜晚事件时显示「✦ 天马星座的流星 💎 在夜色中泛起淡紫色微光……（金币+1🪙）」
- **新增成就**：「🌠 星坠天马」——获得珍品「天马星座的流星」时解锁
- **夜晚判定**：复用萤火虫之愿的关键词检测（`_nightKeywords`），两个珍品可同时触发各自效果

### ✨ 优化 - 困难模式选择记忆 & 快捷操作
- **自动记忆上次选择**：打开困难模式弹窗时，自动从 `localStorage` 恢复上次的难度标签和加成选择，无需每局重新勾选
- **全选/清空按钮**：
  - 难度标签区右上角：「全选全部 / 清空全部」切换按钮，清空时同时清空所有加成
  - 加成区标题右侧：「全选加成 / 清空加成」切换按钮，全选时自动按顺序选择费用允许的加成
- **持久化存储**：选择在 `doStartGame()` 时写入 `localStorage`（`hard_mode_last_tags` / `hard_mode_last_bonuses`）
- **重置清理**：重置游戏时同时清除记忆的难度选择

### 🐛 修复 - 「取长补短」导致属性归零不死亡
- **问题**：携带「取长补短」时，`balance_stats` 加成会将已归零的属性重新拉回正值，导致玩家即使燃油/耐久/舒适降为 0 也不会触发死亡
- **根因**：`clamp()` 将属性下限锁死为 0，之后被动效果和 `balance_stats` 将 0 提升为正值，`checkGameOverConditions` 检查时属性已不为 0
- **修复方案**：
  - `clamp()` 移除下限限制（`Math.max(0, ...)` → 仅保留上限 `Math.min(100, ...)`），允许属性出现负值以确保死亡判定正确
  - `applyHardModePerChoice` 的 `balance_stats` 逻辑：仅对存活属性（`> 0`）进行调平，不再"复活"已归零的属性
  - `triggerPassiveItemEffects` 被动物品效果：所有属性增益前增加 `> 0` 守卫，防止给已归零属性加值
  - `updateTruckStatusDisplay()` 状态栏显示：使用 `Math.max(0, ...)` 包裹宽度和文本，确保 UI 不显示负数

### ✨ 功能 - 新珍品「雾中人的照片」
- **获取方式**：突遇浓雾事件选择「开大灯慢行」后，15% 概率获得
- **被动效果**：持有时，在视线受阻事件（`fog` 浓雾、`sandstorm` 沙尘暴）中免疫所有负面属性效果
- **视觉表现**：
  - 进入视线受阻事件时，事件弹窗内漂浮 👻 鬼魂 emoji 粒子（6个，随机位置/大小/延迟，从底部缓慢上浮并淡出）
  - 事件描述文本末尾追加灰色斜体文字：「一个模糊的身影出现在视线尽头……」
- **免疫提示**：触发免疫时显示「✦ 雾中人的照片 💎 隐约浮现一个守护的身影，为你拨开了迷雾……」
- **新增成就**：「👻 雾中来客」——获得珍品「雾中人的照片」时解锁
- **CSS 动画**：`fogGhostFloat` 关键帧（上浮 350px + 淡入淡出 + 缩放变化）

### ✨ 优化 - 珍品获得特效 & 结局特效清理
- **珍品特效增加横幅黑底**：文字下方新增横穿整个浏览器的半透明渐变黑色条带，与 overlay 同步淡入淡出，避免特效文字与游戏界面冲突
- **结局/死亡清除所有特效**：`showGameOver()` 调用新函数 `clearAllEffects()`，立即移除珍品全屏特效和事件主题粒子/配色
- **珍品特效定时器安全管理**：淡出/移除定时器挂载在 DOM 元素上，`clearTreasureEffect()` 可精确取消

### 🔧 优化 - 商人/制作台界面交互改善
- **滚动位置保留**：商人界面购买/出售物品后，列表不再重置到顶部（保存并恢复 scrollTop）
- **制作台同理**：合成物品后列表滚动位置保持不变
- **允许超载购买/合成**：商人界面和制作台不再阻止超载操作，玩家可自由买入/合成物品
  - 商人界面：超载时购买按钮变为黄色警告样式，附带 ⚠️ 标识和提示
  - 制作台：移除"后备箱容量不足"限制
  - 事件获得物品：同样不再因重量限制丢失
  - 载重信息栏：超载时载重数字变红加粗并显示 ⚠️
- **统一超载判定**：超载检查仅在事件结束/关闭商人/关闭制作台时触发超载弹窗
- **超载阈值调整**：从 `>=` 改为 `>`（刚好满载不再触发超载弹窗，只有严格超过才算超载）

### ✨ 功能 - 设置界面重新开始按钮
- 设置面板底部新增「🔄 重新开始」按钮
- 两步确认机制防止误操作：第一次点击变为「⚠️ 确认放弃本局？」，3秒内再次点击确认
- 确认后删除存档并跳转回主页（index.html）

### ✨ 功能 - 困难模式特殊加成系统
- 玩家选择难度标签获得分数后，可用分数兑换 **特殊加成**（花费总计 ≤ 难度分）
- 3 个加成选项：
  - 🎁 **取长补短**（5分）：每次事件选择后，最高属性 -1%，最低属性 +1%（自动平衡三维）
  - 🎁 **概率平衡**（5分）：所有 `chance` 型效果触发概率 +15%，珍品掉率额外 ×1.3
  - 🎁 **珍品收藏家**（6分）：开局随机获得一件珍品（排除变形产物）
- 选择界面：难度标签区下方新增绿色主题加成区，分数不足时自动禁用选项
- 取消难度标签时自动退还超出的加成（从最贵的开始移除）
- 加成标签在游戏内状态栏以绿色标签显示（🎁 前缀），支持悬停提示
- 加成通过 `sessionStorage` 传递，存入 `gameState.hardModeBonuses`，存档自动持久化
- `hasHardModeBonus()` 工具函数供全局判断加成是否激活

### 🔧 平衡 - 珍品掉落概率全面上调
- **≥10% 的珍品**：概率 ×1.25
  - 沥青滴落装置：10% → **12.5%**
  - 萤火虫之愿：10% → **12.5%**
  - 呓语之书：25% → **31.25%**
- **<10% 的珍品**：概率 ×2.5
  - 繁荣时代的金属碎片：5% → **12.5%**
  - 雨水护符：5% → **12.5%**
  - 金马雕像：2% → **5%**
  - 钻石稿：2% → **5%**
  - 马头皮卡核心：1% → **2.5%**
  - 海市蜃楼雕塑：8% → **20%**
- 未调整的珍品（非概率掉落）：鹿角护符、骚福瑞手办（均为事件必定获得）
- 同步更新了所有相关选项的 `hintKnown` 提示文本

### ✨ 功能 - 困难模式标签详细提示
- 游戏内困难模式标签栏支持 **鼠标悬停显示详细效果**
- 自定义浮动 Tooltip（替代原生 `title`），深红主题卡片样式
- 显示内容：标签名称 + 分值 + 每条具体数值效果（初始属性/每次抉择/概率触发）
- 多条效果自动换行，最大宽度 260px，不遮挡游戏界面

### ✨ 功能 - 游戏内设置面板 & 音量控制
- 右侧面板金币栏旁新增 ⚙️ 设置按钮
- 点击打开设置弹窗，包含三个音量滑块：
  - 🔊 **主音量**：控制所有声音的总音量
  - 🌧️ **环境音**：控制公路白噪音 + 引擎声
  - 🔔 **音效**：控制按钮点击 / 悬停音效
- 滑块实时生效，拖动即时调整增益节点
- 音量设置通过 `localStorage` 自动保存，下次进入游戏自动恢复
- 红色主题滑块样式，与游戏 UI 风格统一

---

## 2026-02-22 (第三次会话)

### ✨ 功能 - 困难模式系统
- 玩家达成任意结局后解锁 **困难模式**
- 点击 START 后弹出模态窗口，可选择难度标签自定义追加难度
- 10 个难度标签，各有分值：
  - 🪑 不舒适的驾驶舱（+1pt）：每次选择 -1% 舒适
  - 🔩 锈蚀的车架（+1pt）：每次选择 -0.5% 耐久
  - ⛽ 漏油的油箱（+1pt）：每次选择 -1% 燃油
  - 📦 沉重的货物（+2pt）：初始负重上限 -15kg
  - 💰 空空的口袋（+2pt）：初始金币 -20
  - 🔧 脆弱的车身（+2pt）：初始耐久 -30%
  - ⛽ 低油量出发（+2pt）：初始燃油 -25%
  - 😔 阴郁的心情（+2pt）：初始舒适 -20%
  - 🎲 坏运气（+3pt）：每次选择 15% 概率随机属性 -3
  - ☠ 三重消耗（+5pt）：每次选择 -0.3% 燃油/耐久/舒适
- 解锁检测：检查 `localStorage` 中的 `chinese_truck_adventure_endings`
- 标签选择通过 `sessionStorage` 传递到游戏页面
- 游戏内状态栏下方显示红色困难模式标签条，展示当前生效的难度标签与总分
- `onStart` 类修饰符在新游戏初始化时立即应用
- `perChoice` / `perChoiceRandom` 类修饰符在每次事件选择后通过 `applyHardModePerChoice()` 应用
- 存档系统兼容：`hardModeTags` 随 `gameState` 自动保存/加载，旧存档默认空数组

### ✨ 功能 - 骚福瑞手办升级为珍品 & 狂热收藏家成就
- 「骚福瑞手办」从 `special` 类别改为 `treasure` 珍品
- 移除原有使用效果（`useEffect: { comfort: 80 }`），改为被动效果
- 被动效果：持有时每次事件选择后 **25% 概率恢复 8% 燃油**
- 获取途径不变：骚福瑞狂欢事件「停车加入派对」/ 条件剧情「saofurry_party」
- 两条获取路径均已验证会触发珍品全屏特效（`showTreasureAcquireEffect`）+ 小红点
- 新增成就「狂热收藏家」（💖 图标）：获得「骚福瑞手办」时解锁

### ✨ 功能 - 沥青滴落装置珍品 & 黑金炼成成就
- 废弃加油站事件「彻底搜索」选项新增 10% 概率获得珍品「沥青滴落装置 💎」
- 暗灰配色 `#4a4a4a`，重量 5kg，类型 `treasure`
- 被动效果：持有时每次做出选择后 **2% 概率获得原油×1**
- 被动物品获取系统：`triggerPassiveItemEffects` 新增 `addItems` 支持，概率触发时自动添加物品并显示获取提示
- 新增成就「黑金炼成」（🛢️ 图标）：获得「沥青滴落装置」时解锁

### ✨ 功能 - 繁荣时代的金属碎片珍品 & 繁荣的回响成就
- 废弃仓库事件「进去搜刮」选项新增 5% 概率获得珍品「繁荣时代的金属碎片 💎」
- 金色配色 `#fbbf24`，重量 8kg，类型 `treasure`
- 被动效果：持有时商人购买价格降低 **25%**（与年迈妇人 -15% 可叠加）
- 实现方式：在 `getEffectiveBuyPrice()` 中检查背包是否持有该物品，乘以 0.75
- 新增成就「繁荣的回响」（✨ 图标）：获得「繁荣时代的金属碎片」时解锁

### ✨ 功能 - 钻石稿珍品 & 矿脉传说成就
- 废弃矿场事件「深入矿场」选项新增 2% 概率获得珍品「钻石稿 💎」
- 冰蓝配色 `#b9f2ff`，重量 5kg，类型 `treasure`
- 可售卖给所有商人，售价 **50 金币**（仅可卖不可买，玩家未持有时不在商人列表显示）
- 商人交易界面优化：支持仅可售卖（无 `buyPrice`）的物品，不显示购买按钮
- 新增成就「矿脉传说」（⛏️ 图标）：获得「钻石稿」时解锁

### ✨ 功能 - 马头皮卡核心珍品 & 第三类接触成就
- 废弃广播塔事件「尝试调出信号」选项新增 1% 概率触发外星信号事件
- 一群马头外星人降临改造皮卡，获得珍品「马头皮卡核心 💎」
- 荧绿配色 `#00ff88`，重量 **-10kg**（减轻车辆负重），类型 `treasure`
- 新增成就「第三类接触」（👽 图标）：获得「马头皮卡核心」时解锁

### ✨ 功能 - 呓语之书珍品 & 命运倒转成就
- 神秘石碑事件新增选项「触摸石碑」：耐久-3/舒适-5；75%舒适-25/25%耐久+10；25% 概率获得珍品「呓语之书 💎」
- 紫色配色 `#9f7aea`，重量 2kg，类型 `treasure` 但可使用（`usable: true`）
- 使用效果：设置 `_effectReversed` 标记，下一次事件选择的 fuel/durability/comfort 效果全部取反
  - 减少燃油 → 增加燃油，增加耐久 → 减少耐久，以此类推
  - 物品获得等其他效果不受影响
- 效果倒转触发后，呓语之书自动变成「空白书 💎」（灰色 `#a0aec0`，重量 2kg，无效果）
- 珍品使用系统：`useItem` 新增 `usable + onUse` 支持，可配置 `setFlag`（设游戏标记）、`transformTo`（转化）、`useMessage`（使用提示）
- 后备箱珍品页标记了 `usable: true` 的物品也会显示「使用」按钮
- 新增成就「命运倒转」（📖 图标）：获得「呓语之书」或「空白书」时解锁

### ✨ 功能 - 海市蜃楼雕塑珍品 & 沙海幻影成就
- 沙尘暴事件选择「全速冲出去」后新增 8% 概率获得珍品「海市蜃楼雕塑 💎」
- 沙金色配色 `#e0a050`，重量 5kg
- 被动效果：当燃油 ≤ 10% 时自动触发，恢复 25% 燃油
- 触发后雕塑碎裂，转化为「破损的雕塑 💎」（灰棕色 `#8b7355`，重量 5kg，无效果）
- 被动系统新增 `condition` 类型：支持条件触发（如 `fuel_low`）+ 物品转化（`transformTo`）
- 转化时显示两段文字：触发特效提示 + 碎裂转化提示
- 新增成就「沙海幻影」（🏜️ 图标）：获得珍品「海市蜃楼雕塑」或「破损的雕塑」时解锁

### 🐛 修复 - 制作台合成判定逻辑修复
- **问题**：部分物品即便满足制作条件（材料充足）也显示为不可制作
- **原因1**：`canCraft()` 的重量检查过于严格——在超载/满载状态下，即使合成后净重量减少（材料比成品重），仍不允许合成
- **修复**：当合成结果重量 ≤ 消耗材料重量时（即合成后减重），即使当前超载也允许合成
- **原因2**：`craftItem()` 通过 `addItem()` 添加成品，而 `addItem` 内部再次做重量检查，可能在边界情况下与 `canCraft` 判定不一致，导致材料已消耗但成品未入库
- **修复**：`craftItem()` 改为直接操作 `inventoryState.items`，绕过 `addItem` 的内置重量检查，保证 `canCraft` 通过则一定能合成成功
- **新增**：非堆叠物品已存在时不允许重复合成，提示"已拥有该物品"
- **优化**：不可合成的配方旁直接显示暗红色原因文字（材料不足/后备箱容量不足/已拥有该物品），无需鼠标悬停
- **优化**：制作台材料拥有量括号使用更暗色调（暗绿/暗红），与物品名形成层级对比

### ✨ 功能 - 金马雕像珍品 & 点石成金成就
- 神秘箱子事件选择「打开它」后新增 2% 概率获得珍品「金马雕像 💎」
- 金色配色 `#ffd700`，重量 5kg
- 被动效果：持有时每次事件选择后有 25% 概率掉落 1~2 金币
- 被动系统 `triggerPassiveItemEffects` 新增 `goldMin` / `goldMax` 金币被动支持
- 触发时显示金色提示：「✦ 金马雕像 💎 散发微光...（金币+X🪙）」
- 新增成就「点石成金」（🐴 图标）：获得珍品「金马雕像」时解锁

### ✨ 功能 - 萤火虫之愿珍品 & 萤火虫祝福成就
- 萤火虫之夜事件「停下欣赏」选项新增 10% 概率获得珍品「萤火虫之愿 💎」
- 物品效果：持有该珍品时，每次触发萤火虫之夜事件自动恢复 2~5 点耐久和 1~2 金币
- 效果在事件弹窗出现后、玩家做出选择时显示金色提示文字
- 新增成就「萤火虫祝福」（✨ 图标）：获得珍品「萤火虫之愿」时解锁
- `addItems` 效果处理后自动检查成就，确保物品获取类成就即时触发
- 物品获取提示使用 `getItemDisplayName()` 显示 💎 后缀

### ⚠️ 功能 - 超载系统 & 满载而归结局
- 当后备箱载重 ≥ 最大载重（50kg）时，游戏暂停并弹出超载界面
- 超载界面显示当前载重/最大载重进度条，红色表示超载、绿色表示正常
- 玩家可在超载界面丢弃物品以降低载重，载重恢复正常后可选择「继续前进」
- 超载状态下「继续前进」按钮禁用（灰色不可点击）
- 玩家可随时在超载界面选择进入结局「📦 满载而归...吗？」
- 新增结局 `overloaded`：标题「满载而归...吗？」，琥珀金配色
- 超载检查覆盖所有恢复游戏的时机：事件选择后、二级选择后、商人/合成/休息界面关闭后

### 🌫️ 功能 - 迷雾事件 ☁️ 特效
- 为「突遇浓雾」事件添加 `theme` 配置
- 新增 `fog` 动画类型：☁️🌫️ emoji 以超大号、慢速水平漂移方式覆盖屏幕，模拟浓雾效果
- 雾气粒子带 `blur(2px)` 滤镜，营造朦胧质感
- 事件期间背景变为深灰蓝色 `#1a1a2a`，状态条颜色变为灰白色调
- 新增 CSS 动画 `@keyframes emojiFogDrift`（水平漂移 + 缩放 + 渐隐渐现）

### 🔨 重构 - 制作台从事件移至后备箱面板
- **移除**「发现废弃工坊」事件（`craft`），制作台不再依赖随机事件触发
- 在后备箱载重条右侧新增「🔨 制作」按钮，玩家随时可打开制作台
- 独立模式制作台使用 `fixed` 定位 + 琥珀金边框，关闭时不影响游戏进程
- 事件模式（`openCraftingModal` 效果）保持原有行为不变
- 技术商人（`tech_merchant`）从解锁事件改为默认可用事件

### 🐛 修复 - 合成系统载重判定 bug
- **原问题**：`canCraft()` 在检查成品能否放入背包时，未扣除消耗材料释放的重量，导致即使材料足够也显示"后备箱容量不足"
- **修复**：计算合成后净重量 = 当前重量 - 材料重量 + 成品重量，再与最大载重比较
- 同步修复 `getCraftUnavailableReason()` 使用相同的净重逻辑

### 🐛 修复 & 🎨 优化 - 商店界面金币显示
- **修复**：商人界面买卖按钮中金币显示为裸字「币」，改为 `数量🪙` 格式（如 `买 15🪙`）
- **优化**：商人界面顶部金币信息栏改为带背景的独立条，显示「持有 XX 🪙」+ 载重信息
- 禁用状态的买按钮金币数字使用半透明样式 `text-yellow-400/50`

### 🆕 功能 - 后备箱「珍品」标签页

### ✨ 功能 - 鹿角护符改为被动珍品
- 类型从 `special`（可使用）改为 `treasure`（珍品，无法使用/丢弃按钮仍保留）
- 移除 `useEffect`（原：燃油+30/耐久+25/舒适+30）
- 新增 `passive: { triggerChance: 0.2, comfort: 5 }`（被动效果配置）
- 在 `event-handler.js` 新增 `triggerPassiveItemEffects()` 函数，每次做出事件选择后自动扫描背包中带有 `passive` 字段的物品并按概率触发
- 触发时在文本区显示：「✦ 鹿角护符 散发微光...（舒适+5%）」
- 被动系统通用化设计，支持 `fuel` / `durability` / `comfort` 任意组合

### 💎 功能 - 珍品物品名称后缀 💎 图标
- 新增 `getItemDisplayName(config)` 工具函数，珍品类物品自动追加 ` 💎` 后缀
- 覆盖全部物品名称显示点：
  - 后备箱物品列表
  - 使用物品消息
  - 丢弃物品消息
  - 商人商店物品名
  - 合成面板产物名 & 材料名
  - 合成成功消息
  - 休息面板可用物品
  - 被动触发消息

### 🆕 功能 - 后备箱「珍品」标签页
- 在后备箱面板头部添加「📦 物品 / 💎 珍品」切换按钮
- 修改 `inventory-display.js`：添加 `currentInventoryTab` 状态和 `switchInventoryTab()` 切换函数
- `updateInventoryDisplay()` 根据当前标签页过滤物品：普通页面排除 `category: "treasure"`，珍品页面只显示 `category: "treasure"`
- 物品分类颜色新增 `treasure` 类型样式（琥珀金边框）
- 珍品页空状态提示：「💎 还没有收集到珍品...」

### 🎯 功能 - 选择记忆系统全量实装
- 为全部 **34个事件、103个选项** 添加了 `hintUnknown`（首次提示）和 `hintKnown`（已知提示）
- 覆盖文件：`events-encounter.js`（9事件28选项）、`events-stop.js`（7事件24选项）、`events-special.js`（13事件35选项）、`events-merchant.js`（5事件16选项）

---

## 2026-02-22 (第一次会话)

### 🆕 功能 - 新增物品「马年红包」
- 在 `items-config.js` 添加马年红包物品配置（消耗品，随机获得 1~6 金币）
- 在 `inventory-system.js` 添加 `randomGold` 使用逻辑
- 在 `text.js` 新游戏初始化时自动获得马年红包

### 🏆 功能 - 新增成就「开年大吉」
- 在 `achievements-config.js` 添加成就配置（使用马年红包后解锁）
- 在 `game-state.js` 添加 `hasOpenedRedPacket` 状态标记
- 在 `inventory-system.js` 使用红包时触发成就检查

### 📊 功能 - 里程面板新增「经历事件」统计
- 在 `game.html` 里程面板添加「经历事件」显示行
- 在 `game-state.js` 添加 `totalEventsHandled` 计数器
- 在 `inventory-display.js` 更新面板时同步显示事件数
- 在 `event-handler.js` 每次处理事件选择时递增计数

### 🐛 修复 - 返回菜单后重新进入游戏无法触发事件
- 原因：`eventTriggered` 和 `textGenerationPaused` 在存档中保持为 `true`，读档后不会重置
- 修复：在 `save-system.js` 的 `loadGame()` 末尾重置这两个标记

### 🎨 功能 - 事件背景主题系统（Emoji粒子特效）
- 在 `event-animation.js` 实现完整主题系统：`applyEventTheme()` / `clearEventTheme()`
- 支持 Emoji 粒子漂浮动画，改变页面背景色、画布边框色、状态栏颜色
- 粒子层挂载在 `<body>` 上，`position: fixed`，覆盖整个页面
- 在 `game.html` 添加 `@keyframes emojiFloat` 动画

### 🌧️ 功能 - 雨滴动画支持
- 在 `game.html` 添加 `@keyframes emojiRainDrop` 垂直下落动画
- 主题配置支持 `animation: "rain"` 模式（40粒子、快速线性下落）
- 为 `rain`（下雨）和 `muddy_downpour`（暴雨泥泞）事件配置雨滴主题

### 🎨 功能 - 事件弹窗颜色跟随主题
- 修改 `event-handler.js` 的 `displayEventModal()`，读取 `event.theme.borderColor`
- 弹窗边框、标题颜色、按钮悬停色随事件主题变化

### 🐛 修复 - 游戏结束后重新开始不重置状态
- 原因：`showGameOver()` 未清除存档 Cookie，`location.reload()` 后 `loadGame()` 恢复了死亡状态
- 修复：在 `save-system.js` 添加 `deleteSave()` 函数，在 `game-over.js` 的 `showGameOver()` 中调用

### 🧠 功能 - 选择效果记忆系统（跨存档永久保存）
- 在 `save-system.js` 实现 localStorage 记忆机制：`getChoiceMemory()`、`recordChoiceMemory()`、`isChoiceRemembered()`
- 在 `event-handler.js` 选择时自动记录，弹窗中根据记忆状态显示 ❓ 未知提示 / 📋 已知提示
- 首批为 3 个事件 9 个选项配置了提示文本（`rain`、`overnight_rest`、`muddy_downpour`）

---

*日志格式：🆕功能 / 🐛修复 / 🎨界面 / 📊数据 / 🏆成就*
