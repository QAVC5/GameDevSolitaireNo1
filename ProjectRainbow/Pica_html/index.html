<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#c41e3a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="çº¢è‰²çš®å¡">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="manifest" href="manifest.json">
    <title>æ— äººçº¢è‰²çš®å¡çš„å®‰ä¿ä¹‹æ—…</title>
    <!-- è®¾å¤‡æ£€æµ‹ï¼šå°½æ—©æ³¨å…¥ï¼Œé¿å…é—ªçƒ -->
    <script src="js/device-adapt.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'chinese': ['Microsoft YaHei', 'SimHei', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 1.2s cubic-bezier(0.16,1,0.3,1)',
                        'fade-out': 'fadeOut 0.5s ease-out forwards',
                        'title-glow': 'titleGlow 3s ease-in-out infinite alternate',
                        'float': 'float 6s ease-in-out infinite',
                        'truck-idle': 'truckIdle 2s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(40px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeOut: {
                            '0%': { opacity: '1', transform: 'translateY(0)' },
                            '100%': { opacity: '0', transform: 'translateY(-30px)' },
                        },
                        titleGlow: {
                            '0%': { textShadow: '0 0 20px rgba(196,30,58,0.4), 0 0 60px rgba(196,30,58,0.1)' },
                            '100%': { textShadow: '0 0 30px rgba(196,30,58,0.7), 0 0 80px rgba(196,30,58,0.2), 0 0 120px rgba(196,30,58,0.1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        truckIdle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '25%': { transform: 'translateY(-2px)' },
                            '75%': { transform: 'translateY(1px)' },
                        },
                    },
                },
            },
        }
    </script>
    <style>
        body {
            background: #0a0a0f;
            overflow: hidden;
            animation: pageFadeIn 0.6s ease-out;
        }
        @keyframes pageFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ç²’å­ç”»å¸ƒ */
        #particle-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* å…¬è·¯çº¿æ¡èƒŒæ™¯ */
        .road-lines {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 120px;
            background: linear-gradient(to top, rgba(20,20,25,0.9), transparent);
            z-index: 1;
            overflow: hidden;
        }
        .road-lines::before {
            content: '';
            position: absolute;
            bottom: 30px; left: 0; right: 0;
            height: 2px;
            background: repeating-linear-gradient(90deg, #c41e3a33 0, #c41e3a33 40px, transparent 40px, transparent 80px);
            animation: roadDash 2s linear infinite;
        }
        @keyframes roadDash {
            from { transform: translateX(0); }
            to { transform: translateX(-80px); }
        }

        /* é¡¶éƒ¨æ¸å˜æ™•å…‰ */
        .top-glow {
            position: fixed;
            top: -200px; left: 50%;
            transform: translateX(-50%);
            width: 800px; height: 500px;
            background: radial-gradient(ellipse, rgba(196,30,58,0.08) 0%, transparent 70%);
            z-index: 0;
            pointer-events: none;
        }

        /* ASCII çš®å¡ */
        .ascii-truck {
            font-family: 'Courier New', monospace;
            color: #c41e3a;
            font-size: 11px;
            line-height: 1.15;
            letter-spacing: 1px;
            text-shadow: 0 0 15px rgba(196,30,58,0.5), 0 0 40px rgba(196,30,58,0.15);
            white-space: pre;
            user-select: none;
            opacity: 0.75;
        }

        /* æ ‡é¢˜ */
        .game-title {
            background: linear-gradient(135deg, #f5f5f5 0%, #c41e3a 50%, #8b0000 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleShimmer 6s ease-in-out infinite;
        }
        @keyframes titleShimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* å‰¯æ ‡é¢˜æ‰“å­—æœºæ•ˆæœ */
        .subtitle-typing {
            overflow: hidden;
            white-space: nowrap;
            border-right: 2px solid #c41e3a;
            animation: typing 2.5s steps(18) 0.8s forwards, blink 0.8s step-end infinite;
            width: 0;
        }
        @keyframes typing {
            from { width: 0; }
            to { width: 18ch; }
        }
        @keyframes blink {
            50% { border-color: transparent; }
        }

        /* START æŒ‰é’® */
        .btn-start {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #c41e3a, #8b0000);
            transition: all 0.4s cubic-bezier(0.16,1,0.3,1);
        }
        .btn-start::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            transition: left 0.6s;
        }
        .btn-start:hover::before {
            left: 100%;
        }
        .btn-start:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 15px 50px rgba(196,30,58,0.5), 0 0 80px rgba(196,30,58,0.2);
        }
        .btn-start:active {
            transform: translateY(-1px) scale(1.01);
        }

        /* æ¬¡è¦æŒ‰é’® */
        .btn-secondary {
            position: relative;
            transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
        }
        .btn-secondary::after {
            content: '';
            position: absolute;
            bottom: -1px; left: 50%;
            width: 0; height: 1px;
            background: #c41e3a;
            transition: all 0.3s;
            transform: translateX(-50%);
        }
        .btn-secondary:hover::after {
            width: 60%;
        }
        .btn-secondary:hover {
            color: #e63950;
            border-color: #c41e3a88;
            transform: translateY(-1px);
        }

        /* ç‰ˆæœ¬å¾½ç«  */
        .version-badge {
            background: linear-gradient(135deg, rgba(196,30,58,0.15), rgba(139,0,0,0.1));
            border: 1px solid rgba(196,30,58,0.25);
            backdrop-filter: blur(8px);
        }

        /* æ»šåŠ¨æ¡ */
        .text-area-scroll {
            scrollbar-width: thin;
            scrollbar-color: #c41e3a #1f2937;
        }
        .text-area-scroll::-webkit-scrollbar { width: 10px; }
        .text-area-scroll::-webkit-scrollbar-track { background: #1f2937; border-radius: 0 10px 10px 0; }
        .text-area-scroll::-webkit-scrollbar-thumb { background: #c41e3a; border-radius: 10px; }
        .text-area-scroll::-webkit-scrollbar-thumb:hover { background: #e63950; }

        /* åˆ†å‰²çº¿è£…é¥° */
        .divider-line {
            height: 1px;
            background: linear-gradient(90deg, transparent, #c41e3a44, transparent);
        }

        /* æ¨¡æ€æ¡†åŠ¨ç”» */
        .modal-backdrop-in {
            animation: modalBgIn 0.3s ease-out forwards;
        }
        .modal-backdrop-out {
            animation: modalBgOut 0.25s ease-in forwards;
        }
        .modal-content-in {
            animation: modalIn 0.35s cubic-bezier(0.16,1,0.3,1) forwards;
        }
        .modal-content-out {
            animation: modalOut 0.25s ease-in forwards;
        }
        @keyframes modalBgIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes modalBgOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(30px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes modalOut {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(-20px) scale(0.97); }
        }

        /* ================================================================
           ç§»åŠ¨ç«¯ / å®‰å“é€‚é…
           .device-mobile  â€” æ‰€æœ‰ç§»åŠ¨è®¾å¤‡
           .device-android â€” ä»…å®‰å“
           .orient-landscape / .orient-portrait â€” æ–¹å‘
           ================================================================ */

        /* ç§»åŠ¨ç«¯ï¼šå…³é—­æº¢å‡ºæ»šåŠ¨ï¼Œç¡®ä¿å…¨å± */
        .device-mobile body {
            overflow: hidden !important;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* ç§»åŠ¨ç«¯æ¨ªå±ï¼šä¸»å®¹å™¨æ•´ä½“ç¼©å°ï¼Œå·¦å³åŒæ å¸ƒå±€ */
        .device-mobile.orient-landscape #container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 5vw;
            padding: 2vh 4vw;
            width: 100%;
            max-width: 100%;
            text-align: left;
        }

        /* ç§»åŠ¨ç«¯æ¨ªå±ï¼šå·¦ä¾§çš®å¡ + æ ‡é¢˜çºµå‘æ’åˆ— */
        .device-mobile.orient-landscape #container .ascii-truck {
            font-size: 8px;
            line-height: 1.1;
            margin-bottom: 0;
        }

        /* ç§»åŠ¨ç«¯æ¨ªå±ï¼šæ ‡é¢˜å­—å·ç¼©å° */
        .device-mobile.orient-landscape #container h1 {
            font-size: clamp(1.1rem, 3.5vw, 2rem) !important;
            letter-spacing: 0.2rem !important;
            margin-bottom: 0.5rem;
        }

        /* ç§»åŠ¨ç«¯æ¨ªå±ï¼šå‰¯æ ‡é¢˜ */
        .device-mobile.orient-landscape .subtitle-typing {
            font-size: 0.65rem;
        }

        /* ç§»åŠ¨ç«¯æ¨ªå±ï¼šåˆ†éš”çº¿ç´§å‡‘ */
        .device-mobile.orient-landscape .divider-line {
            margin: 0.75rem auto;
        }

        /* ç§»åŠ¨ç«¯æ¨ªå±ï¼šSTART æŒ‰é’®æ”¾å¤§è§¦æ‘¸åŒºåŸŸï¼Œä¿æŒè§†è§‰ */
        .device-mobile .btn-start {
            min-height: 52px;
            font-size: clamp(1rem, 4vw, 1.5rem) !important;
            padding: 0.8em 2.5em !important;
            letter-spacing: 0.3rem !important;
        }

        /* ç§»åŠ¨ç«¯ï¼šæ¬¡è¦æŒ‰é’®åŠ å¤§è§¦æ‘¸åŒºåŸŸ */
        .device-mobile .btn-secondary {
            min-height: 44px;
            font-size: 0.75rem !important;
            padding: 0.6em 1.2em !important;
        }

        /* ç§»åŠ¨ç«¯ç«–å±ï¼ˆæ„å¤–æ—‹è½¬æ—¶ï¼‰ï¼šä¿æŒåŸå¸ƒå±€ä½†ç¼©æ”¾å­—å· */
        .device-mobile.orient-portrait #container h1 {
            font-size: clamp(1.2rem, 5vw, 2.5rem) !important;
            letter-spacing: 0.25rem !important;
        }

        /* ç§»åŠ¨ç«¯ï¼šç‰ˆæœ¬å¾½ç« ä½ç½®è°ƒæ•´ï¼ˆé¿å¼€å®‰å…¨åŒºï¼‰ */
        .device-mobile .version-badge {
            bottom: max(12px, env(safe-area-inset-bottom, 12px));
            left: max(12px, env(safe-area-inset-left, 12px));
            font-size: 9px;
        }

        /* ç§»åŠ¨ç«¯ï¼šåº•éƒ¨å¼•å¯¼è¯­ */
        .device-mobile.orient-landscape #container > p:last-child {
            font-size: 0.6rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen flex justify-center items-center overflow-hidden font-chinese">
    <!-- ç²’å­èƒŒæ™¯ -->
    <canvas id="particle-canvas"></canvas>

    <!-- é¡¶éƒ¨æ™•å…‰ -->
    <div class="top-glow"></div>

    <!-- å…¬è·¯çº¿æ¡ -->
    <div class="road-lines"></div>

    <!-- å·¦ä¸‹è§’ç‰ˆæœ¬å¾½ç«  -->
    <div class="fixed bottom-4 left-4 z-10 version-badge px-3 py-1.5 rounded-full">
        <span class="text-[10px] text-gray-400 tracking-wider font-mono">PK-0724 Â· v4.0</span>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="text-center animate-fade-in relative z-10" id="container">

        <!-- ASCII çš®å¡ -->
        <div class="ascii-truck animate-truck-idle mb-6 flex justify-center">
<pre class="inline-block text-left">
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ çš®  å¡  â”‚â•²
â”€â”€â”€â”€â”¤          â”œâ”€â”€â•²â”€â”€â”€â”€â”€â”€â”
    â”‚   PK     â”‚  â”‚  å®‰ä¿ â”‚
â”€â”€â”€â”€â”¤  0724    â”œâ”€â”€â”¤      â”‚
    â””â”€â”€â”¬â”€â”€â”¬â”€â”€â”˜  â””â”€â”¬â”€â”€â”¬â”€â”˜
      (â—)(â—)     (â—)(â—)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
</pre>
        </div>

        <!-- æ ‡é¢˜ -->
        <h1 class="text-5xl md:text-6xl font-black game-title mb-3 tracking-[0.4rem] animate-title-glow leading-tight">
            æ— äººçº¢è‰²çš®å¡çš„å®‰ä¿ä¹‹æ—…
        </h1>

        <!-- å‰¯æ ‡é¢˜ -->
        <div class="flex justify-center mb-2">
            <p class="subtitle-typing text-gray-500 text-sm tracking-[0.3rem] font-mono">ä¸‰å·è”é‚¦å…¬è·¯ Â· 2147</p>
        </div>

        <!-- åˆ†éš”çº¿ -->
        <div class="divider-line w-48 mx-auto my-6"></div>

        <!-- æŒ‰é’®ç»„ -->
        <div class="flex flex-col items-center gap-3 mt-4">
            <button 
                onclick="startGame()"
                class="btn-start px-20 py-5 text-2xl font-black text-white uppercase tracking-[0.4rem] rounded-full cursor-pointer shadow-[0_10px_40px_rgba(196,30,58,0.35)]"
            >
                START
            </button>
            
            <div class="flex gap-3 mt-3">
                <button 
                    onclick="resetGame()"
                    class="btn-secondary px-6 py-2.5 text-xs font-bold text-gray-500 tracking-[0.15rem] rounded-full cursor-pointer border border-gray-700/60"
                >
                    é‡ç½®æ¸¸æˆ
                </button>
                <button 
                    onclick="showAchievements()"
                    class="btn-secondary px-6 py-2.5 text-xs font-bold text-gray-500 tracking-[0.15rem] rounded-full cursor-pointer border border-gray-700/60"
                >
                    ğŸ† æˆå°±
                </button>
                <button 
                    onclick="showJourneyHistory()"
                    class="btn-secondary px-6 py-2.5 text-xs font-bold text-gray-500 tracking-[0.15rem] rounded-full cursor-pointer border border-gray-700/60"
                >
                    ğŸ“œ å†ç¨‹
                </button>
            </div>
        </div>

        <!-- åº•éƒ¨å¼•å¯¼è¯­ -->
        <p class="mt-8 text-gray-600 text-xs tracking-[0.25rem] italic animate-float">"è¿™æ¡è·¯ç°åœ¨æ˜¯ä½ çš„äº†"</p>
    </div>

    <!-- ç²’å­ç³»ç»Ÿ -->
    <script>
    (function() {
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let w, h;

        function resize() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        class Particle {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * w;
                this.y = Math.random() * h;
                this.size = Math.random() * 1.5 + 0.3;
                this.speedX = (Math.random() - 0.6) * 0.3;
                this.speedY = (Math.random() - 0.5) * 0.15;
                this.opacity = Math.random() * 0.4 + 0.05;
                this.pulse = Math.random() * Math.PI * 2;
                this.pulseSpeed = Math.random() * 0.02 + 0.005;
                // å¤§éƒ¨åˆ†ç™½è‰²ï¼Œå°‘é‡çº¢è‰²
                this.isRed = Math.random() < 0.12;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.pulse += this.pulseSpeed;
                if (this.x < -10 || this.x > w + 10 || this.y < -10 || this.y > h + 10) this.reset();
            }
            draw() {
                const alpha = this.opacity * (0.6 + Math.sin(this.pulse) * 0.4);
                if (this.isRed) {
                    ctx.fillStyle = `rgba(196,30,58,${alpha})`;
                    ctx.shadowBlur = 8;
                    ctx.shadowColor = 'rgba(196,30,58,0.3)';
                } else {
                    ctx.fillStyle = `rgba(200,200,210,${alpha})`;
                    ctx.shadowBlur = 0;
                }
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        for (let i = 0; i < 80; i++) particles.push(new Particle());

        function animate() {
            ctx.clearRect(0, 0, w, h);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }
        animate();
    })();
    </script>

    <script src="js/game_config/game-config.js"></script>
    <script src="js/game_config/achievements-config.js"></script>
    <script>
        function isHardModeUnlocked() {
            return true; // TODO: æµ‹è¯•ç”¨ï¼Œæ­£å¼ç‰ˆæ¢å¤ç»“å±€è§£é”æ¡ä»¶
            // try {
            //     const endings = localStorage.getItem("chinese_truck_adventure_endings");
            //     if (endings) {
            //         const arr = JSON.parse(endings);
            //         return Array.isArray(arr) && arr.length > 0;
            //     }
            // } catch (e) {}
            // return false;
        }

        function startGame() {
            // å¦‚æœæœ‰å­˜æ¡£ï¼Œç›´æ¥è¿›å…¥æ¸¸æˆï¼ˆä¸å¼¹å›°éš¾æ¨¡å¼é€‰æ‹©ï¼‰
            const hasSave = document.cookie.indexOf('chinese_truck_adventure_save=') !== -1;
            if (hasSave) {
                doStartGame();
                return;
            }
            // æ£€æŸ¥æ˜¯å¦è§£é”å›°éš¾æ¨¡å¼
            if (isHardModeUnlocked() && typeof HARD_MODE_MODIFIERS !== "undefined" && HARD_MODE_MODIFIERS.length > 0) {
                showHardModeModal();
            } else {
                doStartGame();
            }
        }

        function doStartGame(selectedTags, selectedBonuses) {
            // å°†é€‰ä¸­çš„å›°éš¾æ¨¡å¼æ ‡ç­¾å­˜å…¥ sessionStorageï¼ˆä¾› game.html è¯»å–ï¼‰
            if (selectedTags && selectedTags.length > 0) {
                sessionStorage.setItem("hard_mode_tags", JSON.stringify(selectedTags));
                localStorage.setItem("hard_mode_last_tags", JSON.stringify(selectedTags));
            } else {
                sessionStorage.removeItem("hard_mode_tags");
                localStorage.removeItem("hard_mode_last_tags");
            }
            if (selectedBonuses && selectedBonuses.length > 0) {
                sessionStorage.setItem("hard_mode_bonuses", JSON.stringify(selectedBonuses));
                localStorage.setItem("hard_mode_last_bonuses", JSON.stringify(selectedBonuses));
            } else {
                sessionStorage.removeItem("hard_mode_bonuses");
                localStorage.removeItem("hard_mode_last_bonuses");
            }
            // ç®€å•æ¨¡å¼æ ‡å¿—
            const isEasy = typeof isEasyModeEnabled === "function" ? isEasyModeEnabled() : false;
            sessionStorage.setItem("easy_mode", isEasy ? "true" : "false");
            localStorage.setItem("easy_mode_last", isEasy ? "true" : "false");
            // æ•´ä¸ªé¡µé¢æ·¡å‡º
            document.body.style.transition = 'opacity 0.5s ease-out';
            document.body.style.opacity = '0';
            setTimeout(() => {
                window.location.href = 'game.html';
            }, 500);
        }

        function showHardModeModal() {
            const selected = new Set();
            const selectedBonuses = new Set();
            let totalPoints = 0;
            let totalBonusCost = 0;
            let easyModeEnabled = false;

            // â”€â”€â”€ ä» localStorage è¯»å–ä¸Šæ¬¡é€‰æ‹© â”€â”€â”€
            try {
                const savedEasy = localStorage.getItem("easy_mode_last");
                if (savedEasy === "true") easyModeEnabled = true;
            } catch (e) {}
            try {
                const savedTags = localStorage.getItem("hard_mode_last_tags");
                if (savedTags) {
                    const arr = JSON.parse(savedTags);
                    if (Array.isArray(arr)) {
                        arr.forEach(id => {
                            const mod = HARD_MODE_MODIFIERS.find(m => m.id === id);
                            if (mod) { selected.add(id); totalPoints += mod.points; }
                        });
                    }
                }
                const savedBonuses = localStorage.getItem("hard_mode_last_bonuses");
                if (savedBonuses) {
                    const arr = JSON.parse(savedBonuses);
                    if (Array.isArray(arr)) {
                        arr.forEach(id => {
                            const bonus = (typeof HARD_MODE_BONUSES !== "undefined" ? HARD_MODE_BONUSES : []).find(b => b.id === id);
                            if (bonus && totalBonusCost + bonus.cost <= totalPoints) {
                                selectedBonuses.add(id);
                                totalBonusCost += bonus.cost;
                            }
                        });
                    }
                }
            } catch (e) {}

            function render() {
                const availableBonusPoints = totalPoints - totalBonusCost;

                // ä¿å­˜æ»šåŠ¨ä½ç½®
                let savedScroll = 0;
                const existingModal = document.getElementById('hard-mode-modal');
                if (existingModal) {
                    const scrollBox = existingModal.querySelector('.text-area-scroll');
                    if (scrollBox) savedScroll = scrollBox.scrollTop;
                }

                let html = '<div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 overflow-y-auto p-4 modal-backdrop-in" id="hard-mode-modal">';
                html += '<div class="bg-[#1a1a2e] border-2 border-[#c41e3a] rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto text-area-scroll modal-content-in" id="hard-mode-content">';
                html += '<h2 class="text-2xl font-bold text-[#c41e3a] mb-2 text-center">âš™ï¸ å›°éš¾æ¨¡å¼</h2>';
                html += '<p class="text-gray-400 text-sm mb-1 text-center">è¾¾æˆç»“å±€åè§£é”ï¼Œé€‰æ‹©è¿½åŠ éš¾åº¦æŒ‘æˆ˜è‡ªæˆ‘</p>';

                // â”€â”€â”€ ç®€å•æ¨¡å¼å¼€å…³ï¼ˆå…³é—­è¡°å˜ debuffï¼‰â”€â”€â”€
                const easyBorder = easyModeEnabled ? '#10b981' : '#374151';
                const easyBg = easyModeEnabled ? 'rgba(16,185,129,0.15)' : 'rgba(55,65,81,0.3)';
                const easyCheck = easyModeEnabled ? 'â˜‘' : 'â˜';
                const easyCheckColor = easyModeEnabled ? '#10b981' : '#6b7280';
                const easyTextColor = easyModeEnabled ? 'text-emerald-300' : 'text-gray-400';
                html += '<div onclick="toggleEasyMode()" class="flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-all hover:brightness-110 mb-3" style="border:1px solid ' + easyBorder + '; background:' + easyBg + ';">';
                html += '<span class="text-lg flex-shrink-0" style="color:' + easyCheckColor + '">' + easyCheck + '</span>';
                html += '<div class="flex-1"><span class="text-sm font-bold ' + easyTextColor + '">ğŸ›¡ï¸ ç®€å•æ¨¡å¼</span>';
                html += '<span class="text-xs text-gray-500 ml-2">å…³é—­æ—…é€”è¡°å˜ debuffï¼›é‡Œç¨‹ä¸è®¡å…¥æœ€é«˜è®°å½•</span></div></div>';

                html += '<p class="text-center mb-4"><span class="text-lg font-bold" style="color:' + (totalPoints > 0 ? '#f59e0b' : '#6b7280') + '">éš¾åº¦åˆ†ï¼š' + totalPoints + '</span>';
                if (totalBonusCost > 0) {
                    html += ' <span class="text-sm text-emerald-400 ml-2">å·²ç”¨åŠ æˆï¼š' + totalBonusCost + '/' + totalPoints + '</span>';
                }
                html += '</p>';

                // â”€â”€â”€ éš¾åº¦æ ‡ç­¾åŒº â”€â”€â”€
                const allModsSelected = selected.size === HARD_MODE_MODIFIERS.length;
                html += '<div class="flex items-center justify-between mb-2">';
                html += '<span class="text-xs text-gray-500">éš¾åº¦æ ‡ç­¾</span>';
                html += '<button onclick="toggleAllHardMods()" class="text-xs px-2 py-0.5 rounded border transition-all ' + (allModsSelected ? 'border-gray-600 text-gray-400 hover:border-gray-400' : 'border-[#c41e3a]/60 text-[#c41e3a] hover:border-[#c41e3a]') + '">' + (allModsSelected ? 'æ¸…ç©ºå…¨éƒ¨' : 'å…¨é€‰å…¨éƒ¨') + '</button>';
                html += '</div>';
                html += '<div class="space-y-2 mb-4">';
                HARD_MODE_MODIFIERS.forEach(mod => {
                    const isSelected = selected.has(mod.id);
                    const borderColor = isSelected ? '#c41e3a' : '#374151';
                    const bgColor = isSelected ? 'rgba(196,30,58,0.15)' : 'rgba(55,65,81,0.3)';
                    const checkIcon = isSelected ? 'â˜‘' : 'â˜';
                    const checkColor = isSelected ? '#c41e3a' : '#6b7280';
                    html += '<div onclick="toggleHardMod(\'' + mod.id + '\')" class="flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all hover:brightness-110" style="border:2px solid ' + borderColor + '; background:' + bgColor + ';">';
                    html += '<span class="text-xl flex-shrink-0" style="color:' + checkColor + '">' + checkIcon + '</span>';
                    html += '<div class="flex-1">';
                    html += '<div class="flex items-center gap-2">';
                    html += '<span class="font-bold text-sm ' + (isSelected ? 'text-white' : 'text-gray-300') + '">' + mod.name + '</span>';
                    html += '<span class="text-xs px-1.5 py-0.5 rounded font-mono" style="background:#78350f;color:#fbbf24;">' + mod.points + 'åˆ†</span>';
                    html += '</div>';
                    html += '<div class="text-xs text-gray-500 mt-0.5">' + mod.description + '</div>';
                    html += '</div></div>';
                });
                html += '</div>';

                // â”€â”€â”€ åŠ æˆåŒºï¼ˆä»…å½“æœ‰éš¾åº¦åˆ†æ—¶æ˜¾ç¤ºï¼‰â”€â”€â”€
                if (totalPoints > 0 && typeof HARD_MODE_BONUSES !== "undefined" && HARD_MODE_BONUSES.length > 0) {
                    const allBonusesSelected = HARD_MODE_BONUSES.every(b => selectedBonuses.has(b.id));
                    const anyBonusSelected = selectedBonuses.size > 0;
                    html += '<div class="border-t border-gray-700 pt-4 mb-4">';
                    html += '<div class="flex items-center justify-between mb-1">';
                    html += '<h3 class="text-base font-bold text-emerald-400 flex items-center gap-2">ğŸ ç‰¹æ®ŠåŠ æˆ</h3>';
                    html += '<button onclick="toggleAllHardBonuses()" class="text-xs px-2 py-0.5 rounded border transition-all ' + (anyBonusSelected ? 'border-gray-600 text-gray-400 hover:border-gray-400' : 'border-emerald-600/60 text-emerald-400 hover:border-emerald-400') + '">' + (anyBonusSelected ? 'æ¸…ç©ºåŠ æˆ' : 'å…¨é€‰åŠ æˆ') + '</button>';
                    html += '</div>';
                    html += '<p class="text-xs text-gray-500 mb-3">ç”¨éš¾åº¦åˆ†å…‘æ¢åŠ æˆï¼ŒåŠ æˆæ€»èŠ±è´¹ä¸è¶…è¿‡éš¾åº¦åˆ†ï¼ˆå‰©ä½™å¯ç”¨ï¼š<span class="text-emerald-400 font-bold">' + availableBonusPoints + '</span>ï¼‰</p>';
                    html += '<div class="space-y-2">';
                    HARD_MODE_BONUSES.forEach(bonus => {
                        const isSelected = selectedBonuses.has(bonus.id);
                        const canAfford = availableBonusPoints >= bonus.cost;
                        const enabled = isSelected || canAfford;
                        const borderColor = isSelected ? '#10b981' : (enabled ? '#374151' : '#1f2937');
                        const bgColor = isSelected ? 'rgba(16,185,129,0.15)' : (enabled ? 'rgba(55,65,81,0.3)' : 'rgba(31,41,55,0.2)');
                        const checkIcon = isSelected ? 'â˜‘' : 'â˜';
                        const checkColor = isSelected ? '#10b981' : (enabled ? '#6b7280' : '#374151');
                        const textColor = enabled ? (isSelected ? 'text-white' : 'text-gray-300') : 'text-gray-600';
                        const descColor = enabled ? 'text-gray-500' : 'text-gray-700';
                        const cursor = enabled ? 'cursor-pointer hover:brightness-110' : 'cursor-not-allowed opacity-60';
                        html += '<div onclick="' + (enabled ? 'toggleHardBonus(\'' + bonus.id + '\')' : '') + '" class="flex items-center gap-3 p-3 rounded-lg transition-all ' + cursor + '" style="border:2px solid ' + borderColor + '; background:' + bgColor + ';">';
                        html += '<span class="text-xl flex-shrink-0" style="color:' + checkColor + '">' + checkIcon + '</span>';
                        html += '<div class="flex-1">';
                        html += '<div class="flex items-center gap-2">';
                        html += '<span class="font-bold text-sm ' + textColor + '">' + bonus.name + '</span>';
                        html += '<span class="text-xs px-1.5 py-0.5 rounded font-mono" style="background:#064e3b;color:#6ee7b7;">' + bonus.cost + 'åˆ†</span>';
                        html += '</div>';
                        html += '<div class="text-xs ' + descColor + ' mt-0.5">' + bonus.description + '</div>';
                        html += '</div></div>';
                    });
                    html += '</div></div>';
                }

                html += '<div class="flex gap-3">';
                let btnLabel = 'å¼€å§‹æ—…ç¨‹';
                if (totalPoints > 0 && easyModeEnabled) {
                    btnLabel = 'ğŸ›¡ï¸ ç®€å•æŒ‘æˆ˜ï¼ˆ' + totalPoints + 'åˆ†ï¼‰';
                } else if (totalPoints > 0) {
                    btnLabel = 'ğŸ”¥ æŒ‘æˆ˜å¼€å§‹ï¼ˆ' + totalPoints + 'åˆ†ï¼‰';
                } else if (easyModeEnabled) {
                    btnLabel = 'ğŸ›¡ï¸ ç®€å•æ—…ç¨‹';
                }
                html += '<button onclick="closeHardModeAndStart()" class="flex-1 px-6 py-3 bg-gradient-to-br from-[#c41e3a] to-[#8b0000] text-white font-bold rounded-full hover:from-[#e63950] hover:to-[#c41e3a] transition-all">' + btnLabel + '</button>';
                html += '<button onclick="closeHardModeModal()" class="px-6 py-3 border-2 border-gray-600 text-gray-400 rounded-full hover:border-[#c41e3a] hover:text-[#c41e3a] transition-all">å–æ¶ˆ</button>';
                html += '</div>';
                html += '</div></div>';

                const isRerender = !!document.getElementById('hard-mode-modal');
                const existing = document.getElementById('hard-mode-modal');
                if (existing) existing.remove();
                const el = document.createElement('div');
                el.innerHTML = html;
                const modal = el.firstElementChild;
                // é‡æ¸²æŸ“æ—¶å»æ‰å…¥åœºåŠ¨ç”»ï¼Œé¿å…æ¯æ¬¡åˆ‡æ¢é€‰é¡¹éƒ½é—ª
                if (isRerender) {
                    modal.classList.remove('modal-backdrop-in');
                    const content = modal.querySelector('#hard-mode-content');
                    if (content) content.classList.remove('modal-content-in');
                }
                document.body.appendChild(modal);

                // æ¢å¤æ»šåŠ¨ä½ç½®
                if (savedScroll > 0) {
                    const scrollBox = document.querySelector('#hard-mode-modal .text-area-scroll');
                    if (scrollBox) scrollBox.scrollTop = savedScroll;
                }
            }

            // â”€â”€â”€ æ·¡å‡ºå…³é—­æ¨¡æ€æ¡†ï¼ˆå–æ¶ˆï¼‰â”€â”€â”€
            window.closeHardModeModal = function() {
                const modal = document.getElementById('hard-mode-modal');
                if (!modal) return;
                const content = modal.querySelector('#hard-mode-content');
                modal.classList.remove('modal-backdrop-in');
                modal.classList.add('modal-backdrop-out');
                if (content) {
                    content.classList.remove('modal-content-in');
                    content.classList.add('modal-content-out');
                }
                setTimeout(() => modal.remove(), 260);
            };

            // â”€â”€â”€ æ·¡å‡ºå…³é—­æ¨¡æ€æ¡†ï¼ˆå¼€å§‹æ¸¸æˆï¼‰â”€â”€â”€
            window.closeHardModeAndStart = function() {
                const modal = document.getElementById('hard-mode-modal');
                if (!modal) return;
                const content = modal.querySelector('#hard-mode-content');
                modal.classList.remove('modal-backdrop-in');
                modal.classList.add('modal-backdrop-out');
                if (content) {
                    content.classList.remove('modal-content-in');
                    content.classList.add('modal-content-out');
                }
                setTimeout(() => {
                    modal.remove();
                    doStartGame(getSelectedHardTags(), getSelectedHardBonuses());
                }, 260);
            };

            window.toggleHardMod = function(id) {
                const mod = HARD_MODE_MODIFIERS.find(m => m.id === id);
                if (!mod) return;
                if (selected.has(id)) {
                    selected.delete(id);
                    totalPoints -= mod.points;
                    // å¦‚æœå‡åˆ†ååŠ æˆèŠ±è´¹è¶…å‡ºï¼Œè‡ªåŠ¨å–æ¶ˆå¤šä½™çš„åŠ æˆ
                    while (totalBonusCost > totalPoints && selectedBonuses.size > 0) {
                        // å–æ¶ˆèŠ±è´¹æœ€é«˜çš„åŠ æˆ
                        let maxCostId = null, maxCost = 0;
                        for (const bid of selectedBonuses) {
                            const b = HARD_MODE_BONUSES.find(x => x.id === bid);
                            if (b && b.cost > maxCost) { maxCost = b.cost; maxCostId = bid; }
                        }
                        if (maxCostId) { selectedBonuses.delete(maxCostId); totalBonusCost -= maxCost; }
                        else break;
                    }
                } else {
                    selected.add(id);
                    totalPoints += mod.points;
                }
                render();
            };

            window.toggleHardBonus = function(id) {
                const bonus = HARD_MODE_BONUSES.find(b => b.id === id);
                if (!bonus) return;
                if (selectedBonuses.has(id)) {
                    selectedBonuses.delete(id);
                    totalBonusCost -= bonus.cost;
                } else {
                    if (totalBonusCost + bonus.cost > totalPoints) return;
                    selectedBonuses.add(id);
                    totalBonusCost += bonus.cost;
                }
                render();
            };

            window.toggleAllHardMods = function() {
                if (selected.size === HARD_MODE_MODIFIERS.length) {
                    // æ¸…ç©ºå…¨éƒ¨
                    selected.clear();
                    totalPoints = 0;
                    // åŒæ—¶æ¸…ç©ºæ‰€æœ‰åŠ æˆ
                    selectedBonuses.clear();
                    totalBonusCost = 0;
                } else {
                    // å…¨é€‰å…¨éƒ¨
                    HARD_MODE_MODIFIERS.forEach(mod => {
                        if (!selected.has(mod.id)) {
                            selected.add(mod.id);
                            totalPoints += mod.points;
                        }
                    });
                }
                render();
            };

            window.toggleAllHardBonuses = function() {
                if (selectedBonuses.size > 0) {
                    // æ¸…ç©ºåŠ æˆ
                    selectedBonuses.clear();
                    totalBonusCost = 0;
                } else {
                    // å…¨é€‰åŠ æˆï¼ˆæŒ‰é¡ºåºå°½å¯èƒ½å¤šé€‰ï¼‰
                    const bonuses = typeof HARD_MODE_BONUSES !== "undefined" ? HARD_MODE_BONUSES : [];
                    bonuses.forEach(bonus => {
                        if (!selectedBonuses.has(bonus.id) && totalBonusCost + bonus.cost <= totalPoints) {
                            selectedBonuses.add(bonus.id);
                            totalBonusCost += bonus.cost;
                        }
                    });
                }
                render();
            };

            window.getSelectedHardTags = function() {
                return [...selected];
            };

            window.getSelectedHardBonuses = function() {
                return [...selectedBonuses];
            };

            window.toggleEasyMode = function() {
                easyModeEnabled = !easyModeEnabled;
                render();
            };

            window.isEasyModeEnabled = function() {
                return easyModeEnabled;
            };

            render();
        }

        function resetGame() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿå°†æ¸…é™¤æ‰€æœ‰å­˜æ¡£ã€æˆå°±ã€ç»“å±€è®°å½•ã€å†å²é‡Œç¨‹å’Œå†å²å†ç¨‹ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            // æ¸…é™¤æ¸¸æˆå­˜æ¡£ Cookie
            document.cookie = 'chinese_truck_adventure_save=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            // æ¸…é™¤æˆå°±ã€ç»“å±€ã€é‡Œç¨‹è®°å½•ï¼ˆlocalStorage è·¨æ¡£æ•°æ®ï¼‰
            try {
                localStorage.removeItem('chinese_truck_adventure_achievements');
                localStorage.removeItem('chinese_truck_adventure_endings');
                localStorage.removeItem('chinese_truck_adventure_mileage_best');
                localStorage.removeItem('chinese_truck_adventure_journey_history');
                localStorage.removeItem('hard_mode_last_tags');
                localStorage.removeItem('hard_mode_last_bonuses');
                localStorage.removeItem('easy_mode_last');
            } catch (e) {}
            
            // æ˜¾ç¤ºæç¤º
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'å·²é‡ç½®ï¼';
            btn.classList.add('text-[#c41e3a]', 'border-[#c41e3a]');
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('text-[#c41e3a]', 'border-[#c41e3a]');
            }, 2000);
        }

        function showAchievements() {
            // ä» localStorage åŠ è½½æˆå°±
            let unlockedAchievements = [];
            try {
                const saved = localStorage.getItem("chinese_truck_adventure_achievements");
                if (saved) {
                    unlockedAchievements = JSON.parse(saved);
                }
            } catch (e) {}

            if (typeof ACHIEVEMENTS_CONFIG === "undefined") {
                alert("æˆå°±ç³»ç»ŸæœªåŠ è½½");
                return;
            }

            const allAchievements = Object.values(ACHIEVEMENTS_CONFIG);
            const unlockedSet = new Set(unlockedAchievements);
            
            let html = '<div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 overflow-y-auto p-4">';
            html += '<div class="bg-[#1a1a2e] border-2 border-[#c41e3a] rounded-xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto text-area-scroll">';
            html += '<h2 class="text-3xl font-bold text-[#c41e3a] mb-6 text-center">æˆå°±åˆ—è¡¨</h2>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            
            allAchievements.forEach((ach) => {
                const isUnlocked = unlockedSet.has(ach.id);
                const isHiddenLocked = ach.hidden && !isUnlocked;
                const displayIcon = isHiddenLocked ? '???' : (isUnlocked ? ach.icon : 'â“');
                const displayTitle = ach.title;
                const displayDesc = isHiddenLocked ? '???' : ach.description;
                const showUnlockedHint = !isUnlocked && !ach.hidden;
                html += '<div class="p-4 rounded-lg border-2 ' + 
                    (isUnlocked ? 'border-[#c41e3a] bg-gray-800/50' : 'border-gray-700 bg-gray-900/30 opacity-60') + '">';
                html += '<div class="flex items-center gap-3">';
                html += '<span class="text-2xl">' + displayIcon + '</span>';
                html += '<div class="flex-1">';
                html += '<div class="text-lg font-bold ' + (isUnlocked ? 'text-white' : 'text-gray-500') + '">' + displayTitle + '</div>';
                html += '<div class="text-sm ' + (isUnlocked ? 'text-gray-400' : 'text-gray-600') + '">' + displayDesc + '</div>';
                if (showUnlockedHint) {
                    html += '<div class="text-xs text-gray-600 mt-1">æœªè§£é”</div>';
                }
                html += '</div></div></div>';
            });
            
            html += '</div>';
            html += '<button onclick="this.closest(\'.fixed\').remove()" class="mt-6 w-full px-8 py-3 bg-[#c41e3a] text-white rounded-full hover:bg-[#e63950] transition-all">å…³é—­</button>';
            html += '</div></div>';
            
            const modal = document.createElement('div');
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }

        function showJourneyHistory() {
            let history = [];
            try {
                const saved = localStorage.getItem("chinese_truck_adventure_journey_history");
                if (saved) history = JSON.parse(saved);
            } catch (e) {}

            let html = '<div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 overflow-y-auto p-4">';
            html += '<div class="bg-[#1a1a2e] border-2 border-[#c41e3a] rounded-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto text-area-scroll">';
            html += '<h2 class="text-2xl font-bold text-[#c41e3a] mb-6 text-center">å†å²å†ç¨‹</h2>';
            html += '<p class="text-gray-400 text-sm mb-4 text-center">å›é¡¾ä½ ä¹‹å‰çš„æ—…é€”</p>';

            if (history.length === 0) {
                html += '<div class="text-center text-gray-500 py-12">æš‚æ— æ—…é€”è®°å½•ï¼Œå®Œæˆä¸€å±€æ¸¸æˆåå³å¯åœ¨æ­¤æŸ¥çœ‹ã€‚</div>';
            } else {
                html += '<div class="space-y-4">';
                history.forEach((j, i) => {
                    const date = new Date(j.timestamp);
                    const dateStr = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0') + ' ' + String(date.getHours()).padStart(2, '0') + ':' + String(date.getMinutes()).padStart(2, '0');
                    html += '<div class="p-4 rounded-lg border-2 border-gray-700 bg-gray-800/40 hover:border-[#c41e3a]/60 transition-colors">';
                    html += '<div class="flex items-center justify-between mb-2">';
                    html += '<span class="font-bold text-white text-lg">' + (j.endingTitle || j.endingType) + '</span>';
                    html += '<span class="text-gray-500 text-xs">' + dateStr + '</span>';
                    html += '</div>';
                    html += '<div class="text-sm text-gray-400 space-y-1">';
                    html += '<div>è¡Œé©¶é‡Œç¨‹ï¼š<span class="text-[#c41e3a] font-semibold">' + (j.mileage || 0) + ' km</span></div>';
                    if (j.passengers && j.passengers.length > 0) {
                        html += '<div>åŒè¡Œä¹˜å®¢ï¼š<span class="text-gray-300">' + j.passengers.join('ã€') + '</span></div>';
                    }
                    if (j.sessionAchievements && j.sessionAchievements.length > 0) {
                        html += '<div class="text-xs text-green-400/90 mt-1">è¾¾æˆæˆå°±ï¼š' + j.sessionAchievements.length + ' ä¸ª</div>';
                    }
                    html += '</div></div>';
                });
                html += '</div>';
            }

            html += '<button onclick="this.closest(\'.fixed\').remove()" class="mt-6 w-full px-8 py-3 bg-[#c41e3a] text-white rounded-full hover:bg-[#e63950] transition-all">å…³é—­</button>';
            html += '</div></div>';

            const modal = document.createElement('div');
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }
    </script>

    <!-- PWA Service Worker æ³¨å†Œ -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('[PWA] Service Worker å·²æ³¨å†Œ:', reg.scope))
                    .catch(err => console.warn('[PWA] Service Worker æ³¨å†Œå¤±è´¥:', err));
            });
        }
    </script>
</body>
</html>
